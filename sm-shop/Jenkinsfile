#!groovy
pipeline {
    agent {label 'rpm'}

    stages {
        stage('Build') {
            steps {
                echo '------------ Building ------------'
                withEnv(["JAVA_HOME=${ tool 'jdk1.8' }", "PATH+MAVEN=${tool 'm2'}/bin:${env.JAVA_HOME}/bin"]) {
                    sh "mvn --batch-mode -V -U -e clean compile"
                }
            }
        }
        stage('Test') {
            steps {
                echo '------------ Testing ------------'
                withEnv(["JAVA_HOME=${ tool 'jdk1.8' }", "PATH+MAVEN=${tool 'm2'}/bin:${env.JAVA_HOME}/bin"]) {
                    sh "mvn --batch-mode -V -U -e clean test"
                }
            }
        }
        stage('Build WAR') {
            steps {
                echo '------------ Building the RPM ------------'
                withEnv(["JAVA_HOME=${ tool 'jdk1.8' }", "PATH+MAVEN=${tool 'm2'}/bin:${env.JAVA_HOME}/bin"]) {
                    sh "mvn --batch-mode -V -U -e clean package -DskipTests"
                }
                archiveArtifacts artifacts: 'sm-shop/target/*.war', onlyIfSuccessful: true
            }

        }
        stage('Run Build-Docekr-Image Job') {
            steps {
                echo '------------ Building the Shopize Docker Image ------------'
                build job: 'Build-Docker-Image', parameters: [string(name: 'PARENT_BUILD_NUM', value: '$BUILD_NUMBER')], wait: false
            }

        }
    }
}